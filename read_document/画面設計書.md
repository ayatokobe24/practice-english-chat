# 画面設計書

## 1. はじめに

### 1.1 目的
本ドキュメントは、英語学習チャットアプリケーションの画面設計を定義する。Next.js（App Router、Server Actions）、Supabase、Vercel AI SDKを使用したモダンなWebアプリケーションのUI/UX設計を記載する。

### 1.2 対象画面
* ①テーマ入力画面
* ②3バブル結果表示画面
* ③ブックマーク一覧画面
* ④設定画面（音声/速度）
* ⑤管理画面（管理者用）

### 1.3 技術スタック
* **フロントエンド**: Next.js 14+ (App Router)
* **UI**: React Server Components + Client Components
* **状態管理**: React Hooks (useState, useTransition)
* **認証**: Supabase Auth
* **データ取得**: Server Actions
* **スタイリング**: Tailwind CSS（推奨）またはCSS Modules

### 1.4 デザイン原則
* **モバイルファースト**: スマートフォンでの利用を最優先
* **アクセシビリティ**: WCAG 2.1 AA準拠（コントラスト比≥4.5）
* **パフォーマンス**: 初期表示≤1s、インタラクション応答≤300ms
* **ユーザビリティ**: 3タップ以内で主要操作完了

---

## 2. 画面一覧

| 画面ID | 画面名 | パス | 認証 | 優先度 | 備考 |
|--------|--------|------|------|--------|------|
| SC-001 | ログイン/登録 | `/auth/login` | 不要 | M | Supabase Auth UI |
| SC-002 | テーマ入力 | `/` | 必須 | M | ホーム画面 |
| SC-003 | 3バブル結果 | `/` (同一画面) | 必須 | M | テーマ入力後表示 |
| SC-004 | ブックマーク一覧 | `/bookmarks` | 必須 | M | 検索/フィルタ機能 |
| SC-005 | 設定 | `/settings` | 必須 | S | 音声/速度設定 |
| SC-006 | 管理画面 | `/admin` | Admin | S | 管理者専用 |

---

## 3. 画面詳細設計

### 3.1 SC-001: ログイン/登録画面

#### 3.1.1 概要
Supabase Authを使用した認証画面。メール/パスワード認証、OAuth認証（Google等）をサポート。

#### 3.1.2 レイアウト
```
┌─────────────────────────┐
│   [アプリロゴ/タイトル]    │
│                         │
│   ┌─────────────────┐  │
│   │ メールアドレス      │  │
│   └─────────────────┘  │
│   ┌─────────────────┐  │
│   │ パスワード        │  │
│   └─────────────────┘  │
│                         │
│   [ログインボタン]       │
│                         │
│   [Googleでログイン]    │
│                         │
│   [新規登録リンク]       │
└─────────────────────────┘
```

#### 3.1.3 コンポーネント構成
* `AuthForm` (Client Component)
  * `EmailInput`
  * `PasswordInput`
  * `LoginButton`
  * `OAuthButton` (Google等)
  * `SignUpLink`

#### 3.1.4 機能
* メール/パスワード認証
* OAuth認証（Google、GitHub等）
* パスワードリセットリンク
* エラーメッセージ表示

#### 3.1.5 遷移
* ログイン成功 → `/` (ホーム)
* 新規登録 → `/auth/signup`
* パスワードリセット → `/auth/reset-password`

---

### 3.2 SC-002/003: テーマ入力・3バブル結果画面

#### 3.2.1 概要
学習テーマを入力し、AIが生成した3つの学習メッセージ（バブル）を表示するメイン画面。同一画面内で入力→生成→表示の流れを実現。

#### 3.2.2 レイアウト（テーマ入力状態）
```
┌─────────────────────────┐
│ [☰] 英語学習チャット  [🔖] │ ← ヘッダー
├─────────────────────────┤
│                         │
│   ┌─────────────────┐  │
│   │ 学習テーマを入力    │  │ ← テキストエリア
│   │ (例: ビジネス英語)  │  │
│   └─────────────────┘  │
│                         │
│   [例題テンプレート]      │ ← クイック入力
│   [生成ボタン]           │
│                         │
│   [最近の履歴]           │ ← 直近50件
│   - ビジネス英語        │
│   - 日常会話            │
│                         │
└─────────────────────────┘
```

#### 3.2.3 レイアウト（3バブル結果表示状態）
```
┌─────────────────────────┐
│ [☰] 英語学習チャット  [🔖] │
├─────────────────────────┤
│                         │
│ ┌───────────────────┐  │
│ │ バブル1            │  │
│ │ [テキスト内容]     │  │
│ │ [🔊] [🔖]         │  │ ← 音声再生/ブックマーク
│ └───────────────────┘  │
│                         │
│ ┌───────────────────┐  │
│ │ バブル2            │  │
│ │ [テキスト内容]     │  │
│ │ [🔊] [🔖]         │  │
│ └───────────────────┘  │
│                         │
│ ┌───────────────────┐  │
│ │ バブル3            │  │
│ │ [テキスト内容]     │  │
│ │ [🔊] [🔖]         │  │
│ └───────────────────┘  │
│                         │
│ [新しいテーマを入力]     │ ← 再入力
│                         │
└─────────────────────────┘
```

#### 3.2.4 コンポーネント構成
* `HomePage` (Server Component)
  * `Header` (Client Component)
    * `MenuButton`
    * `BookmarkLink`
  * `ThemeInputForm` (Client Component)
    * `TextArea`
    * `TemplateButtons`
    * `GenerateButton`
    * `LoadingSpinner`
  * `MessageBubbles` (Client Component)
    * `MessageBubble` × 3
      * `MessageText`
      * `AudioPlayer` (Client Component)
      * `BookmarkButton` (Client Component)
  * `HistoryList` (Server Component)
    * `HistoryItem`

#### 3.2.5 状態管理
```typescript
// Client Component内
const [topic, setTopic] = useState<string>('');
const [isGenerating, setIsGenerating] = useState(false);
const [messages, setMessages] = useState<Message[]>([]);
const [isPending, startTransition] = useTransition();
```

#### 3.2.6 Server Actions
```typescript
// app/actions/messages.ts
'use server';

export async function generateMessages(
  topic: string,
  level?: string
): Promise<{ messages: Message[] }> {
  // Vercel AI SDK使用
  // Supabase DB保存
  // 音声生成・Storage保存
}
```

#### 3.2.7 機能詳細

**テーマ入力**
* テキストエリア（最大500文字）
* 例題テンプレートボタン（「ビジネス英語」「日常会話」「旅行」等）
* 生成ボタン（クリック時ローディング表示）
* バリデーション（空文字/文字数超過）

**3バブル表示**
* 各バブルに以下を表示：
  * テキスト内容（最大表示500文字、長文は「続きを読む」）
  * 音声再生ボタン（🔊アイコン、クリックで再生）
  * ブックマークボタン（🔖アイコン、登録済みは塗りつぶし）
* 生成中はスケルトンUI表示
* エラー時はエラーメッセージ表示

**音声再生**
* クリック→≤300msで再生開始（P95）
* 再生中はアイコン変更（⏸️）
* 進捗バー表示（オプション）
* エラー時はリトライボタン表示

**ブックマーク登録**
* クリック→Server Action実行
* 成功時：トースト通知 + アイコン変更
* 失敗時：エラーメッセージ表示
* 重複登録防止（既に登録済みは解除ボタンに変更）

#### 3.2.8 遷移
* ブックマークアイコンクリック → `/bookmarks`
* メニューボタンクリック → サイドメニュー表示

#### 3.2.9 エラーハンドリング
* LLM/TTS失敗時：エラーメッセージ + リトライボタン
* ネットワークエラー：オフライン通知
* 認証エラー：`/auth/login`へリダイレクト

---

### 3.3 SC-004: ブックマーク一覧画面

#### 3.3.1 概要
保存した学習メッセージの一覧を表示。検索、フィルタ、タグ機能を提供。

#### 3.3.2 レイアウト
```
┌─────────────────────────┐
│ [←] ブックマーク一覧      │ ← ヘッダー
├─────────────────────────┤
│ ┌───────────────────┐  │
│ │ 🔍 検索...        │  │ ← 検索バー
│ └───────────────────┘  │
│                         │
│ [タグ] [レベル] [日付]   │ ← フィルタ
│                         │
│ ┌───────────────────┐  │
│ │ バブル1            │  │
│ │ [テキスト内容]     │  │
│ │ [🔊] [🏷️] [🗑️]   │  │ ← 再生/タグ/削除
│ │ タグ: ビジネス     │  │
│ │ 2024/01/15        │  │
│ └───────────────────┘  │
│                         │
│ ┌───────────────────┐  │
│ │ バブル2            │  │
│ │ ...               │  │
│ └───────────────────┘  │
│                         │
│ [前へ] [1] [2] [3] [次へ]│ ← ページネーション
│                         │
└─────────────────────────┘
```

#### 3.3.3 コンポーネント構成
* `BookmarksPage` (Server Component)
  * `BookmarksHeader` (Client Component)
  * `SearchBar` (Client Component)
  * `FilterTabs` (Client Component)
  * `BookmarksList` (Server Component)
    * `BookmarkCard` (Client Component)
      * `MessageText`
      * `AudioPlayer`
      * `TagEditor`
      * `DeleteButton`
  * `Pagination` (Client Component)

#### 3.3.4 Server Actions
```typescript
// app/actions/bookmarks.ts
'use server';

export async function getBookmarks(
  q?: string,
  tag?: string,
  page?: number
): Promise<{ bookmarks: Bookmark[]; total: number }> {
  // Supabase DB検索
}

export async function createBookmark(
  messageId: string
): Promise<Bookmark> {
  // 重複チェック
  // Supabase DB保存
}

export async function deleteBookmark(
  id: string,
  confirm: boolean
): Promise<void> {
  // confirm必須
  // 確認モーダル表示（クライアント側）
  // Supabase DB削除
}

export async function updateBookmarkTags(
  id: string,
  tags: string[]
): Promise<void> {
  // タグ更新
}
```

#### 3.3.5 機能詳細

**検索機能**
* 全文検索（メッセージテキスト）
* リアルタイム検索（デバウンス300ms）
* 検索結果ハイライト

**フィルタ機能**
* タグフィルタ（複数選択可）
* レベルフィルタ（初級/中級/上級）
* 日付フィルタ（今日/今週/今月/すべて）

**ブックマークカード**
* メッセージテキスト（最大200文字、長文は「続きを読む」）
* 音声再生ボタン
* タグ表示・編集（クリックでタグ編集モーダル）
* 削除ボタン（確認モーダル必須）

**ページネーション**
* 1ページ20件表示
* 無限スクロール（オプション）

#### 3.3.6 削除確認モーダル
```
┌─────────────────────────┐
│ 削除確認                  │
├─────────────────────────┤
│                         │
│ このブックマークを削除しますか？│
│                         │
│ [取消]      [削除]      │
│                         │
└─────────────────────────┘
```

* モーダル表示（オーバーレイ）
* ESCキーで閉じる
* 「取消」クリックで閉じる
* 「削除」クリックでServer Action実行

#### 3.3.7 遷移
* 戻るボタン → `/` (ホーム)
* カードクリック → 詳細表示（オプション）

---

### 3.4 SC-005: 設定画面

#### 3.4.1 概要
音声再生速度、音声品質、通知設定などを変更。

#### 3.4.2 レイアウト
```
┌─────────────────────────┐
│ [←] 設定                │
├─────────────────────────┤
│                         │
│ 音声設定                │
│ ┌───────────────────┐  │
│ │ 再生速度: [0.5x]  │  │ ← スライダー
│ └───────────────────┘  │
│                         │
│ ┌───────────────────┐  │
│ │ 音声品質: [標準]  │  │ ← セレクト
│ └───────────────────┘  │
│                         │
│ 通知設定                │
│ ┌───────────────────┐  │
│ │ [✓] ブックマーク通知 │  │ ← トグル
│ └───────────────────┘  │
│                         │
│ [保存]                  │
│                         │
└─────────────────────────┘
```

#### 3.4.3 コンポーネント構成
* `SettingsPage` (Client Component)
  * `AudioSettings`
    * `SpeedSlider` (0.5x - 2.0x)
    * `QualitySelect`
  * `NotificationSettings`
    * `ToggleSwitch`
  * `SaveButton`

#### 3.4.4 機能詳細
* 設定は`localStorage`またはSupabase User Metadataに保存
* 即座に反映（保存ボタン不要でも可）
* デフォルト値：速度1.0x、品質標準

---

### 3.5 SC-006: 管理画面（管理者専用）

#### 3.5.1 概要
不適切コンテンツの監視、通報対応、NGワード管理。

#### 3.5.2 レイアウト
```
┌─────────────────────────┐
│ [☰] 管理画面              │
├─────────────────────────┤
│ [通報一覧] [NGワード] [統計]│ ← タブ
├─────────────────────────┤
│                         │
│ 通報一覧                │
│ ┌───────────────────┐  │
│ │ ID: #123          │  │
│ │ 対象: メッセージ#456 │  │
│ │ 理由: 不適切な内容   │  │
│ │ [承認] [却下] [削除]│  │
│ └───────────────────┘  │
│                         │
│ NGワード管理            │
│ ┌───────────────────┐  │
│ │ [追加] [編集] [削除]│  │
│ └───────────────────┘  │
│                         │
└─────────────────────────┘
```

#### 3.5.3 コンポーネント構成
* `AdminPage` (Server Component, RLSチェック)
  * `AdminTabs` (Client Component)
  * `ReportList` (Server Component)
  * `NGWordManager` (Client Component)

#### 3.5.4 権限チェック
```typescript
// Server Component内
const { data: { user } } = await supabase.auth.getUser();
if (user?.user_metadata?.role !== 'admin') {
  redirect('/');
}
```

---

## 4. UI/UX設計

### 4.1 デザインシステム

#### 4.1.1 カラーパレット
* **プライマリ**: 青系（学習・信頼）
* **セカンダリ**: 緑系（成功・保存）
* **アクセント**: オレンジ系（注意・警告）
* **背景**: 白/ライトグレー（ダークモード対応可）
* **テキスト**: ダークグレー/黒

#### 4.1.2 タイポグラフィ
* **見出し**: 18-24px, Bold
* **本文**: 14-16px, Regular
* **キャプション**: 12px, Regular
* **フォント**: システムフォント（-apple-system

#### 4.1.3 スペーシング
* **グリッド**: 8px基準
* **パディング**: 16px（モバイル）、24px（デスクトップ）
* **マージン**: 8px, 16px, 24px, 32px

#### 4.1.4 コンポーネントライブラリ
* ボタン、入力、カード、モーダル、トースト
* 再利用可能なコンポーネントとして実装

### 4.2 レスポンシブデザイン

#### 4.2.1 ブレークポイント
* **モバイル**: < 768px（優先）
* **タブレット**: 768px - 1024px
* **デスクトップ**: > 1024px

#### 4.2.2 レイアウト調整
* モバイル：1カラム、フルスクリーン
* タブレット：1-2カラム
* デスクトップ：2-3カラム（オプション）

### 4.3 アニメーション・トランジション

#### 4.3.1 原則
* 軽量（60fps維持）
* 意味のある動き（装飾的でない）
* ユーザー設定で無効化可能

#### 4.3.2 適用箇所
* ページ遷移：フェード（200ms）
* バブル表示：フェードイン + スライドアップ（300ms）
* ボタンクリック：リップル効果（100ms）
* ローディング：スケルトンUI

---

## 5. アクセシビリティ

### 5.1 WCAG 2.1 AA準拠

#### 5.1.1 コントラスト比
* テキスト/背景：≥4.5:1
* 大きなテキスト（18px以上）：≥3:1

#### 5.1.2 キーボード操作
* すべての機能をキーボードで操作可能
* Tab順序：論理的な順序
* フォーカスインジケーター：明確に表示

#### 5.1.3 ARIA属性
* 音声再生ボタン：`aria-label="発音再生"`
* ローディング：`aria-live="polite"`
* エラー：`role="alert"`
* モーダル：`role="dialog"`, `aria-modal="true"`

#### 5.1.4 スクリーンリーダー対応
* セマンティックHTML使用
* 適切な見出し階層（h1-h6）
* 画像にalt属性

### 5.2 その他
* フォントサイズ拡大対応（ブラウザ設定に従う）
* モーション軽減対応（`prefers-reduced-motion`）

---

## 6. 状態管理

### 6.1 クライアント状態
* **React Hooks**: `useState`, `useReducer`
* **Server State**: Server Components + Server Actions
* **認証状態**: Supabase Auth（`useUser()` hook）

### 6.2 グローバル状態
* 認証状態：Supabase Auth Context
* 設定：`localStorage` + Context API
* テーマ（ダークモード）：Context API

### 6.3 サーバー状態
* データ取得：Server Components（RSC）
* データ更新：Server Actions
* キャッシュ：Next.js `unstable_cache`

---

## 7. エラーハンドリング

### 7.1 エラー表示

#### 7.1.1 エラーメッセージ
* **ネットワークエラー**: 「接続に失敗しました。再試行してください。」
* **認証エラー**: 「ログインが必要です。」
* **バリデーションエラー**: フィールド下にインライン表示
* **サーバーエラー**: トースト通知 + ログ記録

#### 7.1.2 エラー境界
```typescript
// app/error.tsx
'use client';

export default function Error({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  return (
    <div>
      <h2>エラーが発生しました</h2>
      <button onClick={reset}>再試行</button>
    </div>
  );
}
```

### 7.2 オフライン対応
* Service Worker（オプション）
* オフライン時：通知表示
* データはローカルストレージに一時保存

---

## 8. パフォーマンス最適化

### 8.1 初期表示
* Server Components使用（SSR）
* 画像最適化（Next.js Image）
* フォント最適化（next/font）

### 8.2 インタラクション
* Server Actions使用（APIルート不要）
* `useTransition`で非ブロッキング更新
* デバウンス/スロットル適用

### 8.3 キャッシュ戦略
* 静的コンテンツ：CDNキャッシュ
* 動的コンテンツ：`unstable_cache`（Server Components）
* 音声ファイル：Supabase Storage CDN

---

## 9. 実装方針

### 9.1 ファイル構成
```
app/
├── (auth)/
│   ├── login/
│   └── signup/
├── (main)/
│   ├── page.tsx          # ホーム（テーマ入力・3バブル）
│   ├── bookmarks/
│   │   └── page.tsx
│   ├── settings/
│   │   └── page.tsx
│   └── admin/
│       └── page.tsx
├── actions/
│   ├── messages.ts       # Server Actions
│   └── bookmarks.ts
├── components/
│   ├── ui/               # 共通UIコンポーネント
│   ├── messages/         # メッセージ関連
│   └── bookmarks/        # ブックマーク関連
└── lib/
    └── supabase.ts       # Supabaseクライアント
```

### 9.2 コンポーネント設計原則
* **Server Components優先**: デフォルトでServer Component
* **Client Components最小化**: インタラクション必要な場合のみ
* **コンポーネント分割**: 単一責任の原則
* **再利用性**: 共通コンポーネント化

### 9.3 命名規則
* **コンポーネント**: PascalCase（`MessageBubble.tsx`）
* **Server Actions**: camelCase（`generateMessages`）
* **ファイル**: kebab-case（`message-bubble.tsx`）またはPascalCase

---

## 10. テスト方針

### 10.1 単体テスト
* React Testing Library
* Server Actions単体テスト

### 10.2 E2Eテスト
* Playwright
* 主要フロー（ログイン→生成→ブックマーク）

### 10.3 アクセシビリティテスト
* axe-core
* キーボード操作テスト
* スクリーンリーダーテスト

---

## 11. 優先質問・未確定事項

1. **デザインシステム**: 既存のデザインガイドラインはあるか？
2. **ブランディング**: ロゴ、カラースキームの詳細は？
3. **多言語対応**: 日本語UIの将来拡張は？
4. **プッシュ通知**: ブラウザ通知の要件は？
5. **オフライン機能**: Service Worker実装の優先度は？

---

## 12. 参考資料

* [Next.js App Router Documentation](https://nextjs.org/docs/app)
* [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
* [Vercel AI SDK Documentation](https://sdk.vercel.ai/docs)
* [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
* [React Server Components](https://react.dev/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components)

---

**作成日**: 2024年
**バージョン**: 1.0
**作成者**: システム設計チーム

